<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>HTML Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, interactive-widget=resizes-content">
  <link rel="manifest" href="manifest.json">
  <!-- FontAwesome, CodeMirror, SweetAlert2 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/monokai.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: #1e1e1e; color: #ccc; font-family: sans-serif; }

    .tab-bar {
      display: flex;
      align-items: center;
      padding: .5em;
      background: #2b2b2b;
      border-bottom: 1px solid #444;
      position: relative;
    }
    .tab {
      cursor: pointer;
      padding: .3em .6em;
      margin-right: 1em;
      border-radius: 4px;
      color: #ccc;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .tab.active { background: #444; color: #fff; }
    .menu-btn {
      margin-left: auto;
      font-size: 1.2em;
      cursor: pointer;
      padding: .3em;
    }
    .menu {
      position: absolute;
      top: 2.5em;
      right: 10px;
      background: #333;
      border: 1px solid #555;
      border-radius: 6px;
      display: none;
      flex-direction: column;
      z-index: 999;
    }
    .menu.show { display: flex; }
    .menu button {
      background: none;
      border: none;
      color: #fff;
      padding: .5em 1em;
      text-align: left;
      cursor: pointer;
      width: 160px;
      font-size: 12pt;
    }
    .menu button:hover { background: #444; }

    .panel {
      display: none;
      height: calc(100% - 2.5em);
    }
    .panel.active { display: block; }

    textarea { height: 100%; }

    #previewWrapper {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    #previewFrame {
      flex: 1;
      background: transparent;
      border: none;
      width: 100%;
    }

    #consoleContainer {
      background: #111;
      color: #0f0;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      resize: vertical;
      overflow: hidden;
      max-height: 80%;
      min-height: 40px;
      height: 0;
      transition: height 0.2s;
    }

    #consoleHeader {
      cursor: pointer;
      background: #222;
      padding: 4px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-top: 3px solid #444;
      user-select: none;
    }

    #consoleHeader i {
      transition: transform 0.2s ease;
    }

    #consoleHeader.open i {
      transform: rotate(180deg);
    }

    #consoleOutput {
      overflow: auto;
      flex: 1;
      padding: 10px;
      white-space: pre-wrap;
    }

    #previewBtn {
      display: none;
    }

    #charBar {
      display: none;
    }

    @media only screen and (max-width: 767px) {
      #charBar {
        display: block;
      }
      #charBar .row {
        margin-bottom: 6pt;
      }

      .mobile-char-bar {
        position: fixed;
        bottom: 0;
        width: 100%;
        background: #2a2a2a;
        display: flex;
        overflow-x: auto;
        white-space: nowrap;
        padding: 3pt;
        z-index: 999;
      }

      .mobile-char-bar button {
        background: #444;
        color: #fff;
        border: none;
        padding: 6pt 10pt;
        margin: 0 3pt;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        flex: 0 0 auto;
      }
    }
  </style>
</head>
<body>
  <div class="tab-bar">
    <div class="tab active" data-tab="code"><i class="fa fa-code"></i>Code</div>
    <div class="tab" data-tab="preview" id="previewBtn"><i class="fa fa-eye"></i> Preview</div>
    <div class="tab" data-tab="refreshPreview" id="refreshPreviewBtn"><i class="fa fa-play"></i>Run</div>
    <div class="menu-btn"><i class="fa fa-ellipsis-v"></i></div>
    <div class="menu" id="menu">
      <button id="btn-new">New</button>
      <button id="btn-open">Open</button>
      <button id="btn-save">Save</button>
      <button id="btn-saveas">Save As</button>
      <button id="btn-download">Download</button>
    </div>
  </div>

  <div class="panel active" id="code"><textarea id="codeArea"></textarea></div>

  <div class="panel" id="preview">
    <div id="previewWrapper">
      <iframe id="previewFrame"></iframe>
      <div id="consoleContainer">
        <div id="consoleHeader"><span>Console</span><i class="fa fa-chevron-up"></i></div>
        <pre id="consoleOutput"></pre>
      </div>
    </div>
  </div>

  <div class="panel" id="console"><pre id="consoleOutput"></pre></div>

  <div class="mobile-char-bar" id="charBar">
    <div class="row"></div>
    <div class="row"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/edit/closebrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/edit/closetag.min.js"></script>

  <script>
    const defaultCode = `<style>
  
</style>
<body>
  
</body>
<script>
  
<\/script>`;
  </script>

  <script>
    const editor = CodeMirror.fromTextArea(document.getElementById('codeArea'), {
      mode:'htmlmixed',theme:'monokai',lineNumbers:true, autoCloseTags: true, autoCloseBrackets: true
    });
    editor.setSize('100%','100%');
    editor.setValue(defaultCode);
    const tabs = document.querySelectorAll('.tab');
    let currentFile = null;

    const previewBtn = document.getElementById('previewBtn')

    const consoleContainer = document.getElementById('consoleContainer');
    const consoleHeader = document.getElementById('consoleHeader');
    const consoleOutput = document.getElementById('consoleOutput');
    let consoleOpen = false;

    consoleHeader.onclick = () => {
      consoleOpen = !consoleOpen;
      consoleContainer.style.height = consoleOpen ? '40%' : '0';
      consoleHeader.classList.toggle('open', consoleOpen);
    };

    tabs.forEach(tab => tab.onclick = () => {
      if (tab.dataset.tab == "code" || tab.dataset.tab == "preview") {
        showTab(tab.dataset.tab);
      }

      closeMenu();

      if (tab.dataset.tab === 'refreshPreview') {
        runPreview();
        showTab("preview");
      } else if (tab.dataset.tab === 'console') {
        consoleOutput.textContent = '';
      }
    });

    function showTab(tabName) {
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
      document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === tabName));
    }

    const charBarRows = document.querySelectorAll('#charBar .row');
    const chars = ['=', ';', ':', '(', ')', '{', '}', '<', '>', '[', ']', '"', '+', '-', '/', '*', '&', '|'];
    const pairs = {
      '(': ')',
      '{': '}',
      '[': ']',
      '"': '"',
      '\'': '\''
    };
    chars.forEach((c, i) => {
      const btn = document.createElement('button');
      btn.textContent = c;
      btn.onclick = () => {
        const doc = editor.getDoc();
        const cursor = doc.getCursor();
        if (pairs[c]) {
          doc.replaceRange(c + pairs[c], cursor);
          doc.setCursor({ line: cursor.line, ch: cursor.ch + 1 });
        } else {
          doc.replaceRange(c, cursor);
        }
        editor.focus();
      };

      const entriesPerRow = Math.ceil(chars.length / charBarRows.length)
      let rowIdx = Math.floor(i / entriesPerRow)
      let row = charBarRows[rowIdx]
      row.appendChild(btn);
    });

    document.querySelector('.menu-btn').addEventListener('click', e => {
      e.stopPropagation();
      document.getElementById('menu').classList.toggle('show');
    });
    document.addEventListener('click', e => {
      if (!e.target.closest('.menu') && !e.target.closest('.menu-btn') || e.target.closest('.CodeMirror')) closeMenu();
    });
    function closeMenu() {
      document.getElementById('menu').classList.remove('show');
    }

    document.getElementById('btn-new').onclick = () => { editor.setValue(''); currentFile = null; closeMenu(); };
    document.getElementById('btn-save').onclick = () => { currentFile ? save(currentFile) : swalSave(); closeMenu(); };
    document.getElementById('btn-saveas').onclick = () => { swalSave(); closeMenu(); };
    document.getElementById('btn-open').onclick = () => { swalOpen(); closeMenu(); };
    document.getElementById('btn-download').onclick = () => { download(); closeMenu(); };
    editor.on('focus', closeMenu);

    function swalSave() {
      Swal.fire({
        title: 'Save As',
        input: 'text',
        inputValue: currentFile || '',
        confirmButtonText: 'Save',
        showCancelButton: true,
        background: '#2e2e2e',
        color: '#eee',
        inputPlaceholder: 'Filename'
      }).then(res => {
        if (res.isConfirmed && res.value.trim()) save(res.value.trim());
      });
    }

    function swalOpen() {
      const keys = Object.keys(localStorage).filter(k => k.startsWith('file:'));
      let html = '';
      if (!keys.length) {
        html = '<em>Nothing saved</em>';
      } else {
        keys.forEach(k => {
          const name = k.slice(5);
          html += `<button onclick="loadFile('${name}')" class="swal2-confirm swal2-styled" style="display:block;margin:4px 0;width:100%;">${name}</button>`;
        });
      }
      Swal.fire({
        title: 'Open File',
        html: html,
        showConfirmButton: false,
        background: '#2e2e2e',
        color: '#eee'
      });
    }

    window.loadFile = name => {
      const content = localStorage.getItem('file:' + name);
      if (content !== null) { editor.setValue(content); currentFile = name; }
      Swal.close();
    };

    function save(name) {
      localStorage.setItem('file:' + name, editor.getValue());
      currentFile = name;
    }

    window.addEventListener("message", e => {
      if (e.data && e.data.type === "console") {
        if (e.data.level === "error" && !consoleOpen) consoleHeader.click();
        consoleOutput.textContent += `[${e.data.level}] ${e.data.args.join(' ')}\n`;
        console[e.data.level](...e.data.args)
      }
    });

    function runPreview() {
      const iframe = document.getElementById('previewFrame');
      const code = editor.getValue();
      consoleOutput.textContent = '';

      const blob = new Blob([injectConsoleCapture(code)], {type: "text/html"});

      iframe.src = URL.createObjectURL(blob);

      previewDisplayed = true;

      previewBtn.style.display = "block"
    }

    function injectConsoleCapture(html) {
      const script = `<script>const _send = (level, args) => {parent.postMessage({ type: "console", level, args: args.map(String) }, "*");};console.log = (...args) => { _send("log", args); };console.error = (...args) => { _send("error", args); };window.onerror = (...args) => { _send("error", args); };<\/script>`;
      return script + html;
    }

    function download() {
      const fname = (currentFile || 'untitled') + '.html';
      const blob = new Blob([editor.getValue()], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fname;
      a.click();
    }
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/carbon/sw.js');
    }
  </script>
</body>
</html>
